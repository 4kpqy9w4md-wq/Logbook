<!DOCTYPE html>
<html lang="en">
<head>
  <!-- ===================== -->
  <!-- Meta / App Settings -->
  <!-- ===================== -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <title>Flight Logbook</title>

  <!-- ===================== -->
  <!-- Libraries -->
  <!-- ===================== -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
</head>

<body class="bg-slate-100">
  <div id="root"></div>

<script type="text/babel">
const { useState, useRef } = React;

/* ============================================================
   TIME & VALIDATION UTILITIES
   ============================================================ */

const minutesBetween = (start, end) => {
  if (!start || !end) return 0;
  const s = new Date(`2000-01-01T${start}Z`);
  let e = new Date(`2000-01-01T${end}Z`);
  if (e < s) e.setUTCDate(e.getUTCDate() + 1);
  return Math.round((e - s) / 60000);
};

const estimateNightMinutes = (off, on) => {
  if (!off || !on) return 0;
  let mins = 0;
  let t = new Date(`2000-01-01T${off}Z`);
  let end = new Date(`2000-01-01T${on}Z`);
  if (end < t) end.setUTCDate(end.getUTCDate() + 1);

  while (t < end) {
    const h = t.getUTCHours();
    if (h >= 18 || h < 6) mins++;
    t.setUTCMinutes(t.getUTCMinutes() + 1);
  }
  return mins;
};

const normalizeZuluTime = value => {
  const d = value.replace(/\D/g, "");
  if (d.length === 4) {
    const hh = +d.slice(0,2);
    const mm = +d.slice(2,4);
    if (hh < 24 && mm < 60) return `${d.slice(0,2)}:${d.slice(2)}`;
  }
  return "";
};

const isValidZuluTime = v =>
  /^([01]\d|2[0-3]):[0-5]\d$/.test(v);

/* ============================================================
   OCR ENGINE (PURE / NON-REACT)
   ============================================================ */

/* ---------- OCR Regions (percent-based) ---------- */
const OCR_REGIONS = {
  flightNumber: { x: 0.25, y: 0.06, w: 0.30, h: 0.08 },
  out:          { x: 0.05, y: 0.28, w: 0.20, h: 0.07 },
  off:          { x: 0.05, y: 0.36, w: 0.20, h: 0.07 },
  on:           { x: 0.05, y: 0.44, w: 0.20, h: 0.07 },
  in:           { x: 0.05, y: 0.52, w: 0.20, h: 0.07 }
};

/* ---------- OCR Parsers ---------- */
const parseZuluTimeFromText = text => {
  const m = text.replace(/\s/g,"").match(/(\d{2})(\d{2})/);
  if (!m) return "";
  const hh = +m[1], mm = +m[2];
  return (hh < 24 && mm < 60) ? `${m[1]}:${m[2]}` : "";
};

const parseFlightNumber = text => {
  const m = text.match(/(\d{3,4})/);
  return m ? m[1] : "";
};

/* ---------- Image Cropping ---------- */
const cropImageToRegion = (img, r) => {
  const c = document.createElement("canvas");
  const ctx = c.getContext("2d");
  c.width = img.width * r.w;
  c.height = img.height * r.h;
  ctx.drawImage(
    img,
    img.width * r.x,
    img.height * r.y,
    img.width * r.w,
    img.height * r.h,
    0, 0, c.width, c.height
  );
  return c;
};

/* ---------- OCR Runner ---------- */
async function runPhaseIIOCR(imageFile, setCurrent) {
  const img = new Image();
  img.src = URL.createObjectURL(imageFile);
  await new Promise(res => img.onload = res);

  const results = {};

  for (const [key, region] of Object.entries(OCR_REGIONS)) {
    const cropped = cropImageToRegion(img, region);
    const { data } = await Tesseract.recognize(
      cropped,
      "eng",
      { tessedit_char_whitelist: "0123456789:" }
    );

    if (key === "flightNumber") {
      results.flightNumber = parseFlightNumber(data.text);
    } else {
      results[key + "Time"] = parseZuluTimeFromText(data.text);
    }
  }

  setCurrent(prev => ({ ...prev, ...results }));
  alert("OCR complete ‚Äî verify extracted values.");
}

/* ============================================================
   OCR Helper
   ============================================================ */

    function drawOcrDebugOverlay(img, regions) {
      const canvas = document.createElement("canvas");
      const ctx = canvas.getContext("2d");

      canvas.width = img.width;
      canvas.height = img.height;

      ctx.drawImage(img, 0, 0);

      ctx.strokeStyle = "lime";
      ctx.lineWidth = 3;
      ctx.font = "20px monospace";
      ctx.fillStyle = "lime";

      Object.entries(regions).forEach(([key, r]) => {
        const x = img.width * r.x;
        const y = img.height * r.y;
        const w = img.width * r.w;
        const h = img.height * r.h;

        ctx.strokeRect(x, y, w, h);
        ctx.fillText(key, x + 5, y + 22);
      });

      canvas.style.maxWidth = "100%";
      canvas.style.marginTop = "1rem";

      document.body.appendChild(canvas);
    }

/* ============================================================
   FLIGHT FACTORY
   ============================================================ */

const createEmptyFlight = () => ({
  id: null,
  date: new Date().toISOString().split("T")[0],
  flightNumber: "",
  departure: "",
  arrival: "",
  outTime: "",
  offTime: "",
  onTime: "",
  inTime: "",
  crewRole: "SIC",
  flyingRole: "PM"
});

/* ============================================================
   MAIN APP
   ============================================================ */

function FlightLogbook() {
  const [flights, setFlights] = useState([]);
  const [current, setCurrent] = useState(createEmptyFlight());
  const [editingId, setEditingId] = useState(null);

  const jsonInputRef = useRef(null);
  const fmsCaptureRef = useRef(null);

  const totals = flights.reduce((a,f) => {
    a.total += minutesBetween(f.outTime,f.inTime);
    a.night += estimateNightMinutes(f.offTime,f.onTime);
    return a;
  }, { total:0, night:0 });

  /* ---------- Handlers ---------- */

  const handleFmsCapture = e => {
    const file = e.target.files[0];
    if (!file) return;
    runPhaseIIOCR(file, setCurrent);
    e.target.value = "";
  };

  const saveFlight = () => {
    for (const t of ["outTime","offTime","onTime","inTime"]) {
      if (!isValidZuluTime(current[t])) {
        alert(`Invalid ${t.replace("Time","").toUpperCase()} time`);
        return;
      }
    }
    const entry = { ...current, id: editingId ?? Date.now() };
    setFlights(editingId
      ? flights.map(f => f.id === editingId ? entry : f)
      : [...flights, entry]
    );
    setCurrent(createEmptyFlight());
    setEditingId(null);
  };

  const saveJSON = () => {
    const blob = new Blob([JSON.stringify(flights,null,2)],{type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "flight-logbook.json";
    a.click();
  };

  const loadJSON = e => {
    const f = e.target.files[0];
    if (!f) return;
    const r = new FileReader();
    r.onload = () => setFlights(JSON.parse(r.result));
    r.readAsText(f);
  };

  /* ---------- Render ---------- */

  return (
    <div className="max-w-6xl mx-auto p-4">
      <h1 className="text-3xl font-bold mb-4">‚úàÔ∏è Flight Logbook_v3</h1>

      <div className="grid grid-cols-2 gap-4 mb-6">
        <SummaryCard label="Total Time" value={(totals.total/60).toFixed(1)+" h"} />
        <SummaryCard label="Night Time" value={(totals.night/60).toFixed(1)+" h"} />
      </div>

      <div className="flex flex-wrap gap-2 mb-6">
        <button onClick={saveJSON} className="px-4 py-2 bg-blue-600 text-white rounded-lg">Save JSON</button>
        <button onClick={()=>jsonInputRef.current.click()} className="px-4 py-2 bg-green-600 text-white rounded-lg">Load JSON</button>
        <button onClick={()=>fmsCaptureRef.current.click()} className="px-4 py-2 bg-emerald-600 text-white rounded-lg">üì∑ Scan FMS</button>
        <input ref={jsonInputRef} type="file" onChange={loadJSON} className="hidden" />
        <input ref={fmsCaptureRef} type="file" accept="image/*" capture="environment" onChange={handleFmsCapture} className="hidden" />
      </div>

      <FlightForm current={current} setCurrent={setCurrent} onSave={saveFlight} editing={!!editingId} />
      <FlightTable flights={flights} onEdit={f=>{setCurrent(f);setEditingId(f.id);}} onDelete={id=>setFlights(flights.filter(f=>f.id!==id))} />
    </div>
  );
}

/* ============================================================
   UI COMPONENTS
   ============================================================ */

const SummaryCard = ({ label, value }) => (
  <div className="bg-white p-4 rounded shadow">
    <div className="text-gray-500">{label}</div>
    <div className="text-2xl font-bold">{value}</div>
  </div>
);

/* ---------- Flight Form ---------- */

const FlightForm = ({ current, setCurrent, onSave, editing }) => {

  const timeField = (label, field) => {
    const valid = isValidZuluTime(current[field]);
    return (
      <div>
        <label className="block text-sm text-gray-600 mb-1">{label} (Z)</label>
        <input
          type="text"
          inputMode="numeric"
          placeholder="HHMM"
          value={current[field]}
          onChange={e =>
            setCurrent({ ...current, [field]: e.target.value })
          }
          onBlur={e =>
            setCurrent({ ...current, [field]: normalizeZuluTime(e.target.value) })
          }
          className={`w-full border rounded px-2 py-1 ${
            current[field] && !valid ? "border-red-500 bg-red-50" : ""
          }`}
        />
      </div>
    );
  };

  return (
    <div className="bg-white p-4 rounded shadow mb-6 grid grid-cols-2 gap-4">
      <input type="date" value={current.date}
        onChange={e => setCurrent({ ...current, date: e.target.value })} />

      <input placeholder="Flight #"
        value={current.flightNumber}
        onChange={e => setCurrent({ ...current, flightNumber: e.target.value })} />

      <input placeholder="DEP"
        value={current.departure}
        onChange={e => setCurrent({ ...current, departure: e.target.value })} />

      <input placeholder="ARR"
        value={current.arrival}
        onChange={e => setCurrent({ ...current, arrival: e.target.value })} />

      {timeField("OUT", "outTime")}
      {timeField("OFF", "offTime")}
      {timeField("ON", "onTime")}
      {timeField("IN", "inTime")}

      <button
        onClick={onSave}
        className="col-span-2 bg-indigo-600 text-white py-2 rounded"
      >
        {editing ? "Update Flight" : "Add Flight"}
      </button>
    </div>
  );
};

/* ---------- Flight Table ---------- */

const FlightTable = ({ flights, onEdit, onDelete }) => (
  <table className="w-full bg-white rounded shadow">
    <thead className="bg-slate-200">
      <tr>
        <th>Date</th>
        <th>#</th>
        <th>Route</th>
        <th>OUT‚ÄìIN</th>
        <th>Total</th>
        <th>Night</th>
        <th></th>
      </tr>
    </thead>
    <tbody>
      {flights.map(f => (
        <tr key={f.id} className="border-t text-center">
          <td>{f.date}</td>
          <td>{f.flightNumber}</td>
          <td>{f.departure}-{f.arrival}</td>
          <td>{f.outTime}-{f.inTime}</td>
          <td>{(minutesBetween(f.outTime, f.inTime) / 60).toFixed(1)}</td>
          <td>{(estimateNightMinutes(f.offTime, f.onTime) / 60).toFixed(1)}</td>
          <td>
            <button onClick={() => onEdit(f)} className="text-blue-600">
              Edit
            </button>{" "}
            <button onClick={() => onDelete(f.id)} className="text-red-600">
              ‚úï
            </button>
          </td>
        </tr>
      ))}
    </tbody>
  </table>
);

/* ============================================================
   REACT MOUNT
   ============================================================ */

const root = ReactDOM.createRoot(document.getElementById("root"));
root.render(<FlightLogbook />);
